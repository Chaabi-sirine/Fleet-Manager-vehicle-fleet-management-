<div style="color: green; font-weight: bold; margin-bottom: 16px;">
  Composant Missions chargé, missions prêtes à afficher.
</div>

<div class="missions-container">
  <div class="page-header">
    <div class="header-content">
      <h1>Gestion des Missions</h1>
      <p>Suivi et historique des missions</p>
    </div>
    <button class="btn btn-primary" (click)="createMission()">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <line x1="5" y1="12" x2="19" y2="12"></line>
      </svg>
      Nouvelle Mission
    </button>
  </div>

  <!-- Filtres -->
  <div class="filters-section">
    <div class="filter-buttons">
      <button class="filter-btn" [class.active]="selectedStatus === 'all'" (click)="filterByStatus('all')">
        Toutes ({{ missions.length }})
      </button>
      <button class="filter-btn" [class.active]="selectedStatus === 'en-cours'" (click)="filterByStatus('en-cours')">
        En Cours ({{ getStatusCount('en-cours') }})
      </button>
      <button class="filter-btn" [class.active]="selectedStatus === 'termine'" (click)="filterByStatus('termine')">
        Terminées ({{ getStatusCount('termine') }})
      </button>
      <button class="filter-btn" [class.active]="selectedStatus === 'planifie'" (click)="filterByStatus('planifie')">
        Planifiées ({{ getStatusCount('planifie') }})
      </button>
    </div>
  </div>

  <!-- Liste des missions -->
  <div class="missions-list">
    <div class="mission-card" *ngFor="let mission of filteredMissions">
      <div class="mission-header">
        <div class="mission-title">
          <h3>{{ mission.title }}</h3>
          <p class="mission-id">#{{ mission.id }}</p>
        </div>
        <div [ngClass]="['mission-status', 'status-' + mission.status]">
          {{ getStatusLabel(mission.status) }}
        </div>
      </div>

      <div class="mission-details">
        <div class="detail-row">
          <div class="detail-item">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" y1="2" x2="16" y2="6"></line>
              <line x1="8" y1="2" x2="8" y2="6"></line>
              <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
            <div>
              <div class="label">Date de départ</div>
              <div class="value">
                {{ mission?.startDate | date:'dd/MM/yyyy HH:mm' }}
              </div>
            </div>
          </div>

          <div class="detail-item">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14,2 14,8 20,8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
              <polyline points="10,9 9,9 8,9"></polyline>
            </svg>
            <div>
              <div class="label">Véhicule</div>
              <div class="value">{{ mission?.vehicle || '—' }}</div>
            </div>
          </div>
        </div>

        <div class="detail-row">
          <div class="detail-item">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2">
              <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
              <circle cx="12" cy="10" r="3"></circle>
            </svg>
            <div>
              <div class="label">Trajet</div>
              <div class="value">
                {{ mission.itineraire || (mission.origin + ' → ' + mission.destination) }}
              </div>
            </div>
          </div>

          <div class="detail-item">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
            <div>
              <div class="label">Conducteur</div>
              <div class="value">{{ mission.driver }}</div>
            </div>
          </div>
        </div>

        <div class="detail-row" *ngIf="mission.description">
          <div class="detail-item full-width">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14,2 14,8 20,8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
              <polyline points="10,9 9,9 8,9"></polyline>
            </svg>
            <div>
              <div class="label">Description</div>
              <div class="value">{{ mission.description }}</div>
            </div>
          </div>
        </div>
      </div>

      <div class="mission-actions">
<button class="btn btn-info" (click)="viewMission(mission)">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
            <circle cx="12" cy="12" r="3"></circle>
          </svg>
          Détails
        </button>

        <button class="btn btn-success" *ngIf="mission.status === 'planifie'" (click)="startMission(mission)">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="5,3 19,12 5,21 5,3"></polygon>
          </svg>
          Démarrer
        </button>

        <button class="btn btn-warning" *ngIf="mission.status === 'en-cours'" (click)="completeMission(mission)">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="20,6 9,17 4,12"></polyline>
          </svg>
          Terminer
        </button>
      </div>

      <!-- Modal Détails -->
      <!-- ... ta liste ... -->

<!-- Modal Détails (unique, en dehors du *ngFor) -->
<div *ngIf="showDetailsModal && selectedMission" class="modal-overlay" (click)="closeDetailsModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <h3>Détails de la mission</h3>

    <div class="kv">
      <span class="k">ID :</span>
      <span class="v">{{ selectedMission._id || selectedMission.id }}</span>
    </div>

    <div class="kv">
      <span class="k">Date de création :</span>
      <span class="v">
        {{ selectedMission.raw?.dateCreation || selectedMission.date_creation | date:'dd/MM/yyyy HH:mm' }}
      </span>
    </div>

    <div class="kv">
      <span class="k">Date de modification :</span>
      <span class="v">
        {{ selectedMission.raw?.dateModification || selectedMission.date_modification | date:'dd/MM/yyyy HH:mm' }}
      </span>
    </div>

    <div class="kv">
      <span class="k">Date de départ :</span>
      <span class="v">
        {{ (selectedMission.raw?.dateDebut || selectedMission.startDate) | date:'dd/MM/yyyy HH:mm' }}
      </span>
    </div>

    <div class="kv">
      <span class="k">Date de fin :</span>
      <span class="v">
        {{ (selectedMission.raw?.dateFin || selectedMission.endDate) | date:'dd/MM/yyyy HH:mm' }}
      </span>
    </div>

    <div class="kv">
      <span class="k">Itinéraire :</span>
      <span class="v">
        {{ selectedMission.itineraire || (selectedMission.origin + ' → ' + selectedMission.destination) }}
      </span>
    </div>

    <div class="kv" *ngIf="selectedMission.description">
      <span class="k">Description :</span>
      <span class="v">{{ selectedMission.description }}</span>
    </div>

    <div class="kv">
      <span class="k">Statut :</span>
      <span class="v">
        {{ selectedMission.raw?.statut || getStatusLabel(selectedMission.status) }}
      </span>
    </div>

    <div class="kv" *ngIf="selectedMission.raw?.commentaireValidation || selectedMission.commentaire_validation">
      <span class="k">Commentaire validation :</span>
      <span class="v">
        {{ selectedMission.raw?.commentaireValidation || selectedMission.commentaire_validation }}
      </span>
    </div>

    <div class="kv">
      <span class="k">Véhicule :</span>
      <span class="v">
        {{ selectedMission.raw?.vehicule?.nom || selectedMission.vehicle }}
      </span>
    </div>

    <div class="kv">
      <span class="k">Conducteur :</span>
      <span class="v">
        {{ selectedMission.raw?.utilisateur?.nom || selectedMission.driver }}
      </span>
    </div>

    <div class="kv" *ngIf="selectedMission.raw?.validateur?.nom">
      <span class="k">Validateur :</span>
      <span class="v">{{ selectedMission.raw?.validateur?.nom }}</span>
    </div>

    <div class="kv" *ngIf="selectedMission.raw?.statusHistory || selectedMission.status_history">
      <span class="k">Historique statut :</span>
      <pre class="v">{{ selectedMission.raw?.statusHistory || selectedMission.status_history | json }}</pre>
    </div>

    <div class="actions">
      <button class="btn btn-danger" (click)="closeDetailsModal()">Fermer</button>
    </div>
  </div>
</div>

      <!-- /Modal Détails -->
    </div>
  </div>
</div>

<!-- Modal d'ajout -->
<div class="modal-overlay" *ngIf="showAddModal" (click)="closeAddModal()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Créer une nouvelle mission</h2>
      <button class="modal-close-btn" (click)="closeAddModal()">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M18.3 5.71c-.39-.39-1.02-.39-1.41 0L12 10.59 7.11 5.7c-.39-.39-1.02-.39-1.41 0-.39.39-.39 1.02 0 1.41L10.59 12 5.7 16.89c-.39.39-.39 1.02 0 1.41.39.39 1.02.39 1.41 0L12 13.41l4.89 4.89c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41L13.41 12l4.89-4.89c.38-.38.38-1.02 0-1.4z"/>
        </svg>
      </button>
    </div>

    <form class="modal-content" (ngSubmit)="submitForm()">
      <div class="form-grid">
        <!-- Planification -->
        <div class="form-section">
          <h3 class="section-title">
            <svg viewBox="0 0 24 24" fill="currentColor" class="section-icon">
              <path d="M9 11H7v6h2V11zm4 0h-2v6h2V11zm4 0h-2v6h2V11zm2-7v2H4V4h2V2h2v2h8V2h2v2h2zm0 4H4v10h16V8z"/>
            </svg>
            Planification
          </h3>

          <div class="form-row">
            <div class="form-group">
              <label for="dateDebut">Date de début *</label>
              <input type="datetime-local" id="dateDebut" [(ngModel)]="newMission.dateDebut" name="dateDebut" required>
            </div>

            <div class="form-group">
              <label for="dateFin">Date de fin</label>
              <input type="datetime-local" id="dateFin" [(ngModel)]="newMission.dateFin" name="dateFin">
            </div>
          </div>

          <div class="form-group">
            <label for="itineraire">Itinéraire *</label>
            <input type="text" id="itineraire" [(ngModel)]="newMission.itineraire" name="itineraire"
                   placeholder="Ex: Tunis - Sfax - Sousse" required>
          </div>

          <div class="form-group">
            <label for="statut">Statut</label>
            <select id="statut" [(ngModel)]="newMission.statut" name="statut">
              <option value="EN_ATTENTE">En attente</option>
              <option value="EN_COURS">En cours</option>
              <option value="TERMINEE">Terminée</option>
              <option value="VALIDEE">Validée</option>
              <option value="ANNULEE">Annulée</option>
            </select>
          </div>
        </div>

        <!-- Ressources -->
        <div class="form-section">
          <h3 class="section-title">
            <svg viewBox="0 0 24 24" fill="currentColor" class="section-icon">
              <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 3c1.93 0 3.5 1.57 3.5 3.5S13.93 13 12 13s-3.5-1.57-3.5-3.5S10.07 6 12 6zm7 13H5v-.23c0-.62.28-1.2.76-1.58C7.47 15.82 9.64 15 12 15s4.53.82 6.24 2.19c.48.38.76.97.76 1.58V19z"/>
            </svg>
            Ressources
          </h3>

          <div class="form-group">
            <label for="vehiculeId">Id du véhicule *</label>
            <input type="text" id="vehiculeId" [(ngModel)]="newMission.vehiculeId" name="vehiculeId"
                   placeholder="Saisir l'id du véhicule" required>
          </div>

          <div class="form-group">
            <label for="conducteur">Conducteur *</label>
            <input type="text" id="conducteur" [(ngModel)]="newMission.utilisateurId" name="conducteur"
                   placeholder="Nom du conducteur" required>
          </div>

          <div class="form-group">
            <label for="validateur">Responsable validateur</label>
            <input type="text" id="validateur" [(ngModel)]="newMission.validateurId" name="validateur"
                   placeholder="Nom du responsable validateur">
          </div>
        </div>

        <!-- Détails -->
        <div class="form-section">
          <h3 class="section-title">
            <svg viewBox="0 0 24 24" fill="currentColor" class="section-icon">
              <path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.89 2 2 2h12c1.11 0 2-.9 2-2V8l-6-6zm4 18H6V4h7v5h5v11z"/>
            </svg>
            Détails
          </h3>

          <div class="form-group">
            <label for="description">Description de la mission</label>
            <textarea id="description" [(ngModel)]="newMission.description" name="description" rows="4"
                      placeholder="Décrivez les objectifs et détails de la mission..."></textarea>
          </div>

          <div class="form-group">
            <label for="commentaire">Commentaires de validation</label>
            <textarea id="commentaire" [(ngModel)]="newMission.commentaireValidation" name="commentaire" rows="3"
                      placeholder="Commentaires pour le responsable validateur..."></textarea>
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn-cancel" (click)="closeAddModal()">Annuler</button>
        <button type="submit" class="btn-submit">
          <svg viewBox="0 0 24 24" fill="currentColor" style="width:16px;height:16px;margin-right:8px;">
            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
          </svg>
          Créer la mission
        </button>
      </div>
    </form>
  </div>
</div>
